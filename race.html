<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="./style.css"/>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
    <script src="./firebase.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.8/phaser.min.js"></script>
    <script src="./topgeese.js"></script>
  </head>
  <body>
    <p><a href="index.html">&lt; New Race</a></p>
    <p>Seconds: <span id="countdown"></span></p>
    <p>Gear: <span id="shift-gear"></span></p>
    <button id="resend-order" class="debug">Debug Order</button>
    <div id="modal" class="open">
      <h1 id="banner"></h1>
      <div id="other-ready"></div>
      <button id="ready"></button>
      <p>Shifters: <span id="shifters">0</span>
    </div>
    <script>
      var cupName = localStorage.getItem("race");
      var team = localStorage.getItem("team");
      var raceKey = localStorage.getItem("raceKey");

      if (team === "A") {
        document.getElementById("resend-order").classList.remove("debug");
        document.getElementById("resend-order").addEventListener("click", function debugOrder() {
          showCountdown(0);
        }, false);
      }

      document.getElementById("banner").innerHTML = cupName + " CUP";
      document.getElementById("other-ready").innerHTML = team === "A" ? "team b" : "team a";
      document.getElementById("ready").innerHTML = "TEAM " + team + " READY";

      var countdown = document.getElementById("countdown");
      var shifterData = { A: 0, B: 0 };
      function showCountdown(seconds) {
        countdown.innerHTML = seconds;
        if (seconds > 0) {
          setTimeout(function nextSecond() {
            showCountdown(seconds - 1)
          }, 1000);
        } else {

          GAME_LOCKED = false;
          START_TIME = new Date().getTime();

          if (team === "A") {
            // UNLOCK GAME
            var min = Math.min(shifterData["A"], shifterData["B"]);
            var max = Math.max(shifterData["A"], shifterData["B"]);
            var gears = [];
            for (var i = 0; i < min; i++) {
              var r = Math.floor(Math.random() * min);
              var t = typeof gears[i] === "undefined" ? (i + 1) : gears[i];
              gears[i] = typeof gears[r] === "undefined" ? (r + 1) : gears[r];
              gears[r] = t;
            }
            for (var i = min; i < max; i++) {
              gears.push(i + 1);
            }
            firebase.database().ref("races/" + raceKey).push().set({
              gear: "order",
              order: gears,
              time: new Date().getTime()
            });
          }
        }
      }
      var kickedOff = false;
      function kickoff() {
        document.getElementById("modal").classList.remove("open");
        kickedOff = true;
        var secondsTilStart = 3;
        setTimeout(function delayCountDown() {
          showCountdown(3);
        }, 1000);
      }

      function submitTime() {
        var end = new Date().getTime();
        firebase.database().ref("times").push().set({
          race: cupName,
          raceKey: raceKey,
          millis: end - START_TIME,
          team: team,
          time: end,
        });
      }

      var isReady = false;
      var otherIsReady = false;
      document.addEventListener("config-loaded", function raceIndicators() {
        var raceRef = firebase.database().ref("races/" + raceKey);

        function send(gear) {
          raceRef.push().set({
            gear: gear,
            team: team,
            time: new Date().getTime()
          });
        }

        var startTime = new Date().getTime();
        raceRef.on('child_added', function(data) {
          var json = data.val();
          if (!json.time || json.time < startTime) {
            return;
          }
          console.log(json);
          if (data.key.length > 4) {
            localStorage.setItem("startAt", data.key);
          }
          if (!kickedOff && json.gear === "kickoff") {
            kickoff();
          }
          if (team === json.team) {
            if (!kickedOff && otherIsReady) {
              send("kickoff");
            } else if (!GAME_LOCKED) {
              CURRENT_GEAR = json.gear;
              document.getElementById("shift-gear").innerHTML = CURRENT_GEAR;
            }
          } else {
            if (data.val().gear === "ready") {
              otherIsReady = true;
              document.getElementById("other-ready").classList.add("ready");
              if (!kickedOff && isReady) {
                send("kickoff");
              }
            } else if (data.val().gear === "not-ready") {
              otherIsReady = false;
              document.getElementById("other-ready").classList.remove("ready");
            }
          }
        });

        firebase.database().ref("races/" + raceKey + "/shifters").on('child_added', data => {
          json = data.val();
          shifterData[json.team] += 1;
          document.getElementById("shifters").innerHTML = shifterData[team];
          console.log(shifterData, team);
        });

        document.getElementById("ready").addEventListener("mousedown", function clickReady() {
          isReady = true;
          this.classList.add("ready")
          send("ready");
        }, false);
        /*
        document.addEventListener("mouseup", function clickReady() {
          isReady = false;
          send("not-ready");
          raceRef.push().set({ gear: "not-ready", team: team });
        }, false);
        */
      });
    </script>
  </body>
</html>

