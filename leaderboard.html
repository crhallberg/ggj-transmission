<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Top Geese</title>

    <link rel="stylesheet" href="./style.css"/>
		<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Niconne" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Oswald:400,700" rel="stylesheet">
  </head>
  <body>
		<div id="center_container">
			<div id="current_race">Current race...</div>
			<div id="leaderboard_race_name">Searching...</div><br>
			Time:
			<div id="race_time">00:00.000</div>
      <div class="column wide">
        Team A:<br/>
        <span id="team-A"></span>
      </div>
      <div class="column wide">
        Team B:<br/>
        <span id="team-B"></span>
      </div>
			<br>
			<div id="leaderboard">&mdash;&nbsp; Leaderboard &nbsp;&mdash;</div>
			<table>
				<thead>
          <tr>
            <th>Cup</th>
            <th>Team</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
			</table>
		</div>

    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
    <script src="./firebase.js"></script>
    <script>
      var loopTimer = false;
      var timerStart;
      var timerEl = document.getElementById("race_time");
      function formatTime(millis) {
        var seconds = millis / 1000;
        var minutes = Math.floor(seconds / 60);
        seconds %= 60;
        // Pad
        if (minutes < 10) minutes = "0" + minutes;
        if (seconds < 10) seconds = "0" + seconds.toFixed(3);
        else seconds = seconds.toFixed(3);
        // Display
        return minutes + ":" + seconds;
      }

      var all_times = [];
      function updateLeaderboard() {
        all_times.sort((a, b) => a.millis - b.millis);
        var newestA = -1;
        var newestB = -1;
        for (var i = 0; i < all_times.length; i++) {
          if (all_times[i].team === "A") {
            if (newestA < 0 || all_times[i].time > all_times[newestA]) {
              newestA = i;
            }
          } else {
            if (newestB < 0 || all_times[i].time > all_times[newestB]) {
              newestB = i;
            }
          }
        }
        var table = document.getElementById("table");
        var html = "";
        for (var i = 0; i < 5 && i < all_times.length; i++) {
          html += "<tr";
          if (i === newestA || i === newestB) {
            html += ' class="new"';
          }
          html += "><td>" + all_times[i].race + "</td>"
            + "<td>" + all_times[i].team + "</td>"
            + "<td>" + formatTime(all_times[i].millis) + "</td></tr>";
        }
        table.innerHTML = html;
      }

      var finished = { A: false, B: false };
      var teamATimeEl = document.getElementById("team-A");
      var teamBTimeEl = document.getElementById("team-B");
      function updateTimer() {
        timerEl.innerHTML = formatTime(new Date().getTime() - timerStart);
        if (!finished["A"]) {
          teamATimeEl.innerHTML = formatTime(Math.random() * 5940000);
        }
        if (!finished["B"]) {
          teamBTimeEl.innerHTML = formatTime(Math.random() * 5940000);
        }
        // Repeat
        if (loopTimer) {
          requestAnimationFrame(updateTimer);
        }
      }
      function startTimer() {
        finished = { A: false, B: false };
        timerStart = new Date().getTime();
        loopTimer = true;
        updateTimer();
      }
      function stopTimer(json) {
        finished[json.team] = true;
        document.getElementById("team-" + json.team).innerHTML = formatTime(json.millis);
        loopTimer = !(finished["A"] && finished["B"]);
        if (!loopTimer) {
          timerEl.innerHTML = formatTime(json.millis);
          updateLeaderboard();
        }
      }

      document.addEventListener("config-loaded", function leaderboard() {
        // TODO: Capture races correctly
        var currentRace = null;
        firebase.database().ref().on("child_added", data => {
          var json = data.val();
          if (!json.created || json.created < startTime) {
            return;
          }
          if (currentRace) {
            firebase.database().ref(currentRace + "/kickoff").off("value");
            firebase.database().ref(currentRace + "/times").off("child_added");
            loopTimer = false;
            setTimeout(function() {
              timerEl.innerHTML = formatTime(0);
              document.getElementById("team-A").innerHTML = formatTime(0);
              document.getElementById("team-B").innerHTML = formatTime(0);
            }, 100);
          }
          currentRace = data.key;
          document.getElementById("leaderboard_race_name").innerHTML = json.name + " Cup";
          firebase.database().ref(currentRace + "/kickoff").on("value", data => {
            var json = data.val();
            console.log(json);
            if (!json.time || json.time < startTime) {
              return;
            }
            if (json.kickoff) {
              setTimeout(startTimer, 4000);
            }
          });
          // Final times
          firebase.database().ref(currentRace + "/times").on('child_added', function(data) {
            json = data.val();
            if (!json.time || json.time < startTime) {
              return;
            }
            all_times.push(json);
            stopTimer(json);
          });
        });
      }, false);
    </script>
  </body>
</html>
