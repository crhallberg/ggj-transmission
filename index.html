<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="./style.css"/>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
    <script src="./firebase.js"></script>
  </head>
  <body>
    <h2>WELCOME TO THE</h2>
    <div class="cup">
      <input id="name" type="text"/> CUP! <button id="new">new</button>
    </div>
    <hr/>
    <div><button id="start">START!</button></div>
    <hr/>
    <button href="shifter.html#A">add TEAM A shifter</button>
    <button href="shifter.html#B">add TEAM B shifter</button>
    <div id="modal"></div>
    <script>
      var nameField = document.getElementById("name");
      var adjs = [
        "HAPPY",
        "BULLSHIT",
        "AGGRESSIVE",
        "SLIPPERY",
        "ZEN",
        "QUIET",
        "WORLD",
      ];
      var nouns = [
        "LLAMA",
        "STAR",
        "FOREST",
        "TIN",
        "TORNADO",
        "CANYON",
        "MARSH",
      ];
      function newName() {
        nameField.value = adjs[Math.floor(Math.random() * adjs.length)] + " " + nouns[Math.floor(Math.random() * nouns.length)];
      }
      newName();

      document.getElementById("start").addEventListener("click", function connectToRace() {
        var cupName = nameField.value.replace(/[^a-zA-Z0-9]+/g, "-").toLowerCase();
        localStorage.setItem("race", nameField.value);
        localStorage.setItem("raceKey", cupName);

        firebase.database().ref('races/' + cupName).once('value').then(exists => {
          var modal = document.getElementById("modal");
          if (!exists.val()) {
            modal.innerHTML = "You are Team<b>A</b>";
            firebase.database().ref('races').child(cupName).set({ gear: "start", team: "A", time: new Date() });
            var checkLoop = setInterval(function check() {
              firebase.database().ref('races/' + cupName).once('value').then(latest => {
                if (latest.key.length > 4) {
                  localStorage.setItem("startAt", latest.key);
                }
                localStorage.setItem("team", "A");
                if (latest.val().team === "B") {
                  clearInterval(checkLoop);
                  modal.innerHTML = "You are Team<b>A</b>READY";
                  setTimeout(function showTeam() {
                    window.location = "race.html";
                  }, 1000);
                }
              });
            }, 1000);
          } else {
            modal.innerHTML = "You are Team<b>B</b>";
            firebase.database().ref('races').child(cupName).set({ gear: "start", team: "B", time: new Date() });
            localStorage.setItem("team", "B");
            setTimeout(function showTeam() {
              window.location = "race.html";
            }, 1000);
          }
          modal.classList.add("open");
        });
      }, false);

      // document.getElementById("start").addEventListener("click", function connectToRace() {
    </script>
  </body>
</html>
